# RhinoLog (GEL Training Log) コード解説

## 概要

このプロジェクトは、Rhinoceros 3D の操作ログを記録するプラグインシステムです。主に教育・研修目的で使用者の操作履歴を追跡するために設計されています。

## プロジェクト構成

ソリューションは3つのプロジェクトで構成されています:

1. **GELTrainingLog** - Rhinoプラグイン本体
2. **GELGHTrainingLog** - Grasshopperコンポーネント
3. **GELTrainingSetup** - 研修期間設定ツール

## 主な機能

### 1. GELTrainingLogPlugin.cs - メインプラグイン

#### ログ記録対象

- **オブジェクト操作** (198-218行目)
  - オブジェクトの追加・削除
  - レイヤー情報、オブジェクトタイプの記録

- **コマンド実行** (220-298行目)
  - コマンド開始・終了の記録
  - 特殊コマンドの処理:
    - NamedView: 名前付きビューの保存
    - Worksession: リンクモデルの記録
    - Save/SaveAs: ファイル保存時の詳細情報

- **ビュー操作** (329-362行目)
  - ビューポート切り替え
  - CPlane（構築平面）の変更

- **ドキュメント操作** (300-327行目)
  - ドキュメントの開閉
  - ファイル情報（作成日時、更新日時、サイズ）

#### 記録データ

**CSVログファイル形式:**
```csv
Timestamp,UserID,Action,Detail
2025-11-11 10:30:45,username,Command Started,Line
2025-11-11 10:30:46,Object Added,ID:xxx, Type:Curve, Layer:Default
```

**JSONメタデータ:**
```json
{
  "UserID": "username",
  "SessionTimestamp": "20251111_103045",
  "DocumentName": "example",
  "RhinoVersion": "7.0",
  "OS": "Windows",
  "MachineName": "PC-NAME"
}
```

#### 出力先

- 保存場所: `Desktop\GEL\RH\{ユーザー名}\{セッションタイムスタンプ}\`
- CSVログファイル: `{ユーザー名}_{ドキュメント名}_Log.csv`
- JSONメタファイル: `{ユーザー名}_{ドキュメント名}_Meta.json`
- 保存時メタデータ: `{ユーザー名}_SaveMeta.json`

### 2. 研修期間制御機能

#### デフォルト設定 (44-45行目)
```csharp
private DateTime? _periodStart = new DateTime(2025, 5, 19);
private DateTime? _periodEnd = new DateTime(2025, 5, 30);
```

#### 期間ファイル読み込み (151-184行目)

- `Desktop\GEL\training_period.json` から研修期間を読み込み
- ファイル形式:
```json
{
  "user_name": "username",
  "start_date": "2025-05-19",
  "end_date": "2025-05-30",
  "description": "GEL Training Period",
  "created_at": "2025-11-11 10:00:00"
}
```

#### ログフィルタリング (74-79行目)

期間外の操作はログに記録されません:
```csharp
if (_periodStart.HasValue && _periodEnd.HasValue)
{
    if (now < _periodStart.Value || now > _periodEnd.Value)
        return; // ログを記録しない
}
```

### 3. GELTrainingSetup (Program.cs) - セットアップツール

対話型のコンソールアプリケーション:

1. **ユーザー名入力**
   - 必須項目
   - 空白チェック

2. **研修期間設定**
   - デフォルト: 2025-05-19 ～ 2025-05-30
   - カスタム入力可能
   - 日付フォーマット検証 (yyyy-MM-dd)

3. **JSONファイル生成**
   - 保存先: `Desktop\GEL\training_period.json`
   - UTF-8 BOM付きで保存
   - 日本語対応エンコーディング

### 4. 非同期ログ書き込みシステム (403-437行目)

#### アーキテクチャ

```csharp
private readonly object _logLock = new();
private readonly Queue<string> _logQueue = new();
```

- **キューベース**: ログエントリをキューに格納
- **別スレッド**: Task.Runで非同期処理
- **ロック機構**: スレッドセーフな書き込み
- **待機戦略**: キューが空の場合は100ms待機

#### 処理フロー

1. メインスレッド: ログをキューに追加 (82-85行目)
2. ワーカースレッド: キューから取り出してファイルに書き込み
3. エラー時: コンソールに警告メッセージ表示

## 技術的な特徴

### 1. イベント駆動アーキテクチャ

RhinoCommonのイベントシステムにフック:
```csharp
RhinoDoc.AddRhinoObject += OnAddObject;
RhinoDoc.DeleteRhinoObject += OnDeleteObject;
Command.BeginCommand += OnCommandBegin;
Command.EndCommand += OnCommandEnd;
RhinoDoc.CloseDocument += OnCloseDocument;
RhinoDoc.BeginOpenDocument += OnBeginOpenDocument;
RhinoApp.Idle += OnIdle;
```

### 2. スレッドセーフ設計

- `lock (_logLock)` による排他制御
- キューによる生産者・消費者パターン
- Idle イベントでのビュー変更検出

### 3. 動的ファイル名管理

ドキュメント保存時の自動リネーム機能 (265-283行目):
- "Untitled" から実際のファイル名へ更新
- ログファイルとメタファイルの両方をリネーム
- ファイル存在チェックとパス重複回避

### 4. フラグ制御

```csharp
private bool _isOpening = false;
private bool _firstViewInitialized = false;
```

- `_isOpening`: ファイル開封時の重複ログ防止
- `_firstViewInitialized`: 初回ビュー初期化の制御

### 5. リフレクションの使用 (GELTrainingLogCommand.cs)

プライベートメソッドへのアクセス:
```csharp
logger.GetType().GetMethod("Log",
    System.Reflection.BindingFlags.NonPublic |
    System.Reflection.BindingFlags.Instance)
    ?.Invoke(logger, new object[] { "Custom Command", EnglishName });
```

## データフロー

1. **起動時** (OnLoad)
   - ユーザーID取得
   - ログフォルダ作成
   - 研修期間読み込み
   - セッションファイル初期化
   - イベントハンドラ登録
   - 非同期ログライター起動

2. **操作中**
   - イベント発火
   - Log() メソッド呼び出し
   - 期間チェック
   - キューに追加
   - 非同期でファイル書き込み

3. **終了時** (OnShutdown)
   - イベントハンドラ解除

## 用途

### 教育・トレーニング

- 学習者の操作パターン分析
- スキル評価のための客観的データ収集
- 研修期間中の活動追跡
- モデリング手順の可視化

### データ分析

収集されたログから以下の分析が可能:
- コマンド使用頻度
- 作業時間の計測
- オブジェクト編集履歴
- ビュー切り替えパターン

## 製作者情報

- **作者**: Yuko Ishizu
- **組織**: Geometry Engineering Lab
- **ウェブサイト**: https://geometryengineeringlab.tech

## システム要件

- .NET SDK 6.0以上（rollForward設定あり）
- Rhinoceros 3D (バージョン7以上推奨)
- Windows OS

## ファイル構成

```
RhinoLog/
├── GELTrainigLog.sln
├── global.json
├── GELTrainingLog/
│   ├── GELTrainingLogPlugin.cs      # メインプラグイン
│   ├── GELTrainingLogCommand.cs     # コマンド実装
│   └── GELTrainingLog.csproj
├── GELGHTrainingLog/
│   ├── GELGHTrainingLogInfo.cs      # Grasshopperコンポーネント情報
│   ├── GELGHLogAssemblyPriority.cs
│   └── GELGHTrainingLog.csproj
└── GELTrainingSetup/
    ├── Program.cs                    # セットアップツール
    └── GELTrainingSetup.csproj
```

## 注意事項

1. **プライバシー**: ユーザーの全操作が記録されるため、使用前に同意が必要
2. **ディスク容量**: 長時間使用でログファイルが大きくなる可能性
3. **パフォーマンス**: 非同期処理により影響は最小限だが、大量操作時は注意
4. **期間設定**: training_period.json がない場合はデフォルト期間が使用される
